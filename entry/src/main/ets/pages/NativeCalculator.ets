// import textToSpeech from '@ohos.textToSpeech' // HarmonyOSçŽ¯å¢ƒä½¿ç”¨
// WebçŽ¯å¢ƒä½¿ç”¨Web Speech API

@Entry
@Component
struct NativeCalculator {
  @State display: string = '0'
  @State expression: string = ''
  @State isVoiceActive: boolean = false
  @State lastResult: string = ''

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Text('ðŸ§® è¯­éŸ³è®¡ç®—å™¨')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2196F3')
        .textAlign(TextAlign.Center)
        .margin({ top: 20, bottom: 10 })
      
      Text('HarmonyOS åŽŸç”Ÿç‰ˆæœ¬')
        .fontSize(14)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })

      // æ˜¾ç¤ºå±
      Column() {
        Text(this.expression || '0')
          .fontSize(16)
          .fontColor('#999')
          .textAlign(TextAlign.End)
          .width('100%')
          .margin({ bottom: 10 })
          
        Text(this.display)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .textAlign(TextAlign.End)
          .width('100%')
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#f8f8f8')
      .borderRadius(15)
      .margin({ bottom: 30 })
      
      // è¯­éŸ³æŒ‰é’®
      Button() {
        Row() {
          Text(this.isVoiceActive ? 'ðŸ”´' : 'ðŸŽ¤')
            .fontSize(20)
            .margin({ right: 8 })
          Text(this.isVoiceActive ? 'è¯­éŸ³è¯†åˆ«ä¸­...' : 'è¯­éŸ³è¾“å…¥')
            .fontSize(16)
            .fontColor(Color.White)
        }
      }
      .width('90%')
      .height(50)
      .backgroundColor(this.isVoiceActive ? '#f44336' : '#9c27b0')
      .borderRadius(25)
      .margin({ bottom: 20 })
      .onClick(() => {
        this.toggleVoice()
      })

      // æŒ‰é”®ç½‘æ ¼
      Grid() {
        // ç¬¬ä¸€è¡Œ
        GridItem() { this.CalculatorButton('C', '#ff9800', () => this.clear()) }
        GridItem() { this.CalculatorButton('âŒ«', '#ff9800', () => this.backspace()) }
        GridItem() { this.CalculatorButton('Ã·', '#ff9800', () => this.inputOperator('Ã·')) }
        GridItem() { this.CalculatorButton('Ã—', '#ff9800', () => this.inputOperator('Ã—')) }
        
        // ç¬¬äºŒè¡Œ
        GridItem() { this.CalculatorButton('7', '#2196F3', () => this.inputNumber('7')) }
        GridItem() { this.CalculatorButton('8', '#2196F3', () => this.inputNumber('8')) }
        GridItem() { this.CalculatorButton('9', '#2196F3', () => this.inputNumber('9')) }
        GridItem() { this.CalculatorButton('-', '#ff9800', () => this.inputOperator('-')) }
        
        // ç¬¬ä¸‰è¡Œ
        GridItem() { this.CalculatorButton('4', '#2196F3', () => this.inputNumber('4')) }
        GridItem() { this.CalculatorButton('5', '#2196F3', () => this.inputNumber('5')) }
        GridItem() { this.CalculatorButton('6', '#2196F3', () => this.inputNumber('6')) }
        GridItem() { this.CalculatorButton('+', '#ff9800', () => this.inputOperator('+')) }
        
        // ç¬¬å››è¡Œ
        GridItem() { this.CalculatorButton('1', '#2196F3', () => this.inputNumber('1')) }
        GridItem() { this.CalculatorButton('2', '#2196F3', () => this.inputNumber('2')) }
        GridItem() { this.CalculatorButton('3', '#2196F3', () => this.inputNumber('3')) }
        GridItem() { this.CalculatorButton('=', '#4caf50', () => this.calculate()) }
        
        // ç¬¬äº”è¡Œ
        GridItem() { this.CalculatorButton('0', '#2196F3', () => this.inputNumber('0')) }
        GridItem() { this.CalculatorButton('.', '#2196F3', () => this.inputNumber('.')) }
        GridItem() { this.CalculatorButton('è¯­éŸ³', '#9c27b0', () => this.simulateVoiceInput()) }
        GridItem() { this.CalculatorButton('ðŸ“Š', '#607d8b', () => this.showHistory()) }
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr 1fr 1fr')
      .width('90%')
      .height(400)
      .columnsGap(8)
      .rowsGap(8)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
    .padding(20)
  }

  @Builder
  CalculatorButton(text: string, color: string, onClick: () => void) {
    Button(text)
      .fontSize(18)
      .fontColor(Color.White)
      .backgroundColor(color)
      .borderRadius(8)
      .width('100%')
      .height('100%')
      .onClick(onClick)
  }

  // è¾“å…¥æ•°å­—
  inputNumber(num: string) {
    if (this.display === '0' && num !== '.') {
      this.display = num
    } else {
      this.display += num
    }
    this.expression += num
    // æ’­æ”¾æ•°å­—éŸ³é¢‘
    this.playNumberAudio(num)
  }

  // æ’­æ”¾æ•°å­—éŸ³é¢‘
  playNumberAudio(num: string) {
    try {
      let audioText = num === '.' ? 'ç‚¹' : num
      // ä½¿ç”¨Web Speech API
      if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(audioText)
        utterance.lang = 'zh-CN'
        utterance.rate = 1.0
        utterance.pitch = 1.0
        window.speechSynthesis.speak(utterance)
      } else {
        console.log('æ’­æ”¾æ•°å­—éŸ³é¢‘:', audioText)
      }
    } catch (error) {
      console.error('æ•°å­—éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error)
    }
  }

  // è¾“å…¥è¿ç®—ç¬¦
  inputOperator(op: string) {
    if (this.expression.length > 0) {
      this.expression += ` ${op} `
      this.display = '0'
      // æ’­æ”¾è¿ç®—ç¬¦éŸ³é¢‘
      this.playOperatorAudio(op)
    }
  }

  // æ’­æ”¾è¿ç®—ç¬¦éŸ³é¢‘
  playOperatorAudio(op: string) {
    try {
      // æ ¹æ®è¿ç®—ç¬¦æ’­æ”¾å¯¹åº”éŸ³é¢‘
      let audioText = ''
      switch (op) {
        case '+':
          audioText = 'åŠ '
          break
        case '-':
          audioText = 'å‡'
          break
        case 'Ã—':
          audioText = 'ä¹˜'
          break
        case 'Ã·':
          audioText = 'é™¤'
          console.log('é™¤æ³•ç¬¦å·è°ƒè¯•: è¾“å…¥ç¬¦å·=', op, 'éŸ³é¢‘æ–‡æœ¬=', audioText)
          break
        default:
          audioText = op
      }
      
      console.log('è¿ç®—ç¬¦éŸ³é¢‘æ’­æ”¾è°ƒè¯•: ç¬¦å·=', op, 'éŸ³é¢‘æ–‡æœ¬=', audioText)
      
      // ä½¿ç”¨Web Speech API
      if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
        console.log('Web Speech API å¯ç”¨ï¼Œå¼€å§‹æ’­æ”¾:', audioText)
        const utterance = new SpeechSynthesisUtterance(audioText)
        utterance.lang = 'zh-CN'
        utterance.rate = 1.0
        utterance.pitch = 1.0
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨è¿›è¡Œè°ƒè¯•
        utterance.onstart = () => console.log('è¯­éŸ³å¼€å§‹æ’­æ”¾:', audioText)
        utterance.onend = () => console.log('è¯­éŸ³æ’­æ”¾ç»“æŸ:', audioText)
        utterance.onerror = (event) => console.error('è¯­éŸ³æ’­æ”¾é”™è¯¯:', event)
        
        window.speechSynthesis.speak(utterance)
      } else {
        console.log('Web Speech API ä¸å¯ç”¨ï¼Œæ’­æ”¾è¿ç®—ç¬¦éŸ³é¢‘:', audioText)
      }
    } catch (error) {
      console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error)
    }
  }

   // æ’­æ”¾ç»“æžœéŸ³é¢‘
   playResultAudio(result: string) {
     try {
       // å¦‚æžœç»“æžœåŒ…å«çº¦ç­‰äºŽç¬¦å·ï¼Œåªæ’­æŠ¥æ•°å­—éƒ¨åˆ†
       let resultText = result
       if (result.startsWith('â‰ˆ')) {
         resultText = result.substring(1) // åŽ»æŽ‰â‰ˆç¬¦å·
       }
       
       // é™åˆ¶è¯­éŸ³æ’­æŠ¥çš„å°æ•°ä½æ•°ä¸º2ä½
       const num = parseFloat(resultText)
       if (!isNaN(num) && resultText.includes('.')) {
         const parts = resultText.split('.')
         if (parts[1] && parts[1].length > 2) {
           resultText = num.toFixed(2)
         }
       }
       
       let audioText = 'ç­‰äºŽ' + resultText
       // ä½¿ç”¨Web Speech API
       if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
         const utterance = new SpeechSynthesisUtterance(audioText)
         utterance.lang = 'zh-CN'
         utterance.rate = 1.0
         utterance.pitch = 1.0
         window.speechSynthesis.speak(utterance)
       } else {
         console.log('æ’­æ”¾ç»“æžœéŸ³é¢‘:', audioText)
       }
     } catch (error) {
       console.error('ç»“æžœéŸ³é¢‘æ’­æ”¾é”™è¯¯:', error)
     }
   }

  // è®¡ç®—ç»“æžœ
  calculate() {
    try {
      let expr = this.expression.replace(/Ã—/g, '*').replace(/Ã·/g, '/')
      
      // æ£€æŸ¥é™¤æ•°ä¸º0çš„æƒ…å†µ
      if (expr.includes('/')) {
        const parts = expr.split('/')
        if (parts.length === 2 && parseFloat(parts[1].trim()) === 0) {
          this.display = 'ä¸èƒ½é™¤ä»¥é›¶'
          return
        }
      }
      
      let result = eval(expr)
      
      // æ£€æŸ¥ç»“æžœæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
      if (!isFinite(result)) {
        this.display = 'é”™è¯¯'
        return
      }
      
      // é™åˆ¶å°æ•°ç‚¹åŽæœ€å¤š2ä½
      let resultStr = result.toString()
      let isApproximate = false
      
      if (resultStr.includes('.')) {
        const parts = resultStr.split('.')
        const integerPart = parts[0]
        const decimalPart = parts[1]
        
        if (decimalPart.length > 2) {
          // å°æ•°ä½æ•°è¶…è¿‡2ä½ï¼Œä¿ç•™2ä½å°æ•°
          resultStr = parseFloat(resultStr).toFixed(2)
          isApproximate = true
        }
      }
      
      // å¦‚æžœç»“æžœè¢«æˆªæ–­æˆ–ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ï¼Œæ·»åŠ çº¦ç­‰äºŽç¬¦å·
      if (isApproximate) {
        resultStr = 'â‰ˆ' + resultStr
      }
      
      this.lastResult = this.expression + ' = ' + resultStr
      this.display = resultStr
      this.expression = resultStr
      // æ’­æ”¾ç»“æžœéŸ³é¢‘
      this.playResultAudio(resultStr)
    } catch (error) {
      this.display = 'é”™è¯¯'
    }
  }

  // æ¸…é™¤
  clear() {
    this.display = '0'
    this.expression = ''
  }

  // é€€æ ¼
  backspace() {
    if (this.display.length > 1) {
      this.display = this.display.slice(0, -1)
    } else {
      this.display = '0'
    }
    if (this.expression.length > 0) {
      this.expression = this.expression.slice(0, -1)
    }
  }

  // åˆ‡æ¢è¯­éŸ³çŠ¶æ€
  toggleVoice() {
    this.isVoiceActive = !this.isVoiceActive
    if (this.isVoiceActive) {
      // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
      setTimeout(() => {
        this.isVoiceActive = false
        this.simulateVoiceInput()
      }, 2000)
    }
  }

  // æ¨¡æ‹Ÿè¯­éŸ³è¾“å…¥
  simulateVoiceInput() {
    const voiceCommands = [
      { text: 'äºŒåŠ ä¸‰', expression: '2 + 3' },
      { text: 'äº”ä¹˜å››', expression: '5 Ã— 4' },
      { text: 'åå‡å…­', expression: '10 - 6' },
      { text: 'å…«é™¤äºŒ', expression: '8 Ã· 2' }
    ]
    
    const random = voiceCommands[Math.floor(Math.random() * voiceCommands.length)]
    
    AlertDialog.show({
      title: 'è¯­éŸ³è¯†åˆ«',
      message: `è¯†åˆ«åˆ°: "${random.text}"\nå°†è¾“å…¥: ${random.expression}`,
      confirm: {
        value: 'ç¡®è®¤',
        action: () => {
          this.expression = random.expression
          this.calculate()
        }
      },
      cancel: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    })
  }

  // æ˜¾ç¤ºåŽ†å²
  showHistory() {
    AlertDialog.show({
      title: 'è®¡ç®—åŽ†å²',
      message: this.lastResult || 'æš‚æ— è®¡ç®—åŽ†å²',
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    })
  }
}