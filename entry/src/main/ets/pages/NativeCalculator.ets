@Entry
@Component
struct NativeCalculator {
  @State display: string = '0'
  @State expression: string = ''
  @State isVoiceActive: boolean = false
  @State lastResult: string = ''

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Text('ðŸ§® è¯­éŸ³è®¡ç®—å™¨')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2196F3')
        .textAlign(TextAlign.Center)
        .margin({ top: 20, bottom: 10 })
      
      Text('HarmonyOS åŽŸç”Ÿç‰ˆæœ¬')
        .fontSize(14)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })

      // æ˜¾ç¤ºå±
      Column() {
        Text(this.expression || '0')
          .fontSize(16)
          .fontColor('#999')
          .textAlign(TextAlign.End)
          .width('100%')
          .margin({ bottom: 10 })
          
        Text(this.display)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .textAlign(TextAlign.End)
          .width('100%')
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#f8f8f8')
      .borderRadius(15)
      .margin({ bottom: 30 })
      
      // è¯­éŸ³æŒ‰é’®
      Button() {
        Row() {
          Text(this.isVoiceActive ? 'ðŸ”´' : 'ðŸŽ¤')
            .fontSize(20)
            .margin({ right: 8 })
          Text(this.isVoiceActive ? 'è¯­éŸ³è¯†åˆ«ä¸­...' : 'è¯­éŸ³è¾“å…¥')
            .fontSize(16)
            .fontColor(Color.White)
        }
      }
      .width('90%')
      .height(50)
      .backgroundColor(this.isVoiceActive ? '#f44336' : '#9c27b0')
      .borderRadius(25)
      .margin({ bottom: 20 })
      .onClick(() => {
        this.toggleVoice()
      })

      // æŒ‰é”®ç½‘æ ¼
      Grid() {
        // ç¬¬ä¸€è¡Œ
        GridItem() { this.CalculatorButton('C', '#ff9800', () => this.clear()) }
        GridItem() { this.CalculatorButton('âŒ«', '#ff9800', () => this.backspace()) }
        GridItem() { this.CalculatorButton('Ã·', '#ff9800', () => this.inputOperator('Ã·')) }
        GridItem() { this.CalculatorButton('Ã—', '#ff9800', () => this.inputOperator('Ã—')) }
        
        // ç¬¬äºŒè¡Œ
        GridItem() { this.CalculatorButton('7', '#2196F3', () => this.inputNumber('7')) }
        GridItem() { this.CalculatorButton('8', '#2196F3', () => this.inputNumber('8')) }
        GridItem() { this.CalculatorButton('9', '#2196F3', () => this.inputNumber('9')) }
        GridItem() { this.CalculatorButton('-', '#ff9800', () => this.inputOperator('-')) }
        
        // ç¬¬ä¸‰è¡Œ
        GridItem() { this.CalculatorButton('4', '#2196F3', () => this.inputNumber('4')) }
        GridItem() { this.CalculatorButton('5', '#2196F3', () => this.inputNumber('5')) }
        GridItem() { this.CalculatorButton('6', '#2196F3', () => this.inputNumber('6')) }
        GridItem() { this.CalculatorButton('+', '#ff9800', () => this.inputOperator('+')) }
        
        // ç¬¬å››è¡Œ
        GridItem() { this.CalculatorButton('1', '#2196F3', () => this.inputNumber('1')) }
        GridItem() { this.CalculatorButton('2', '#2196F3', () => this.inputNumber('2')) }
        GridItem() { this.CalculatorButton('3', '#2196F3', () => this.inputNumber('3')) }
        GridItem() { this.CalculatorButton('=', '#4caf50', () => this.calculate()) }
        
        // ç¬¬äº”è¡Œ
        GridItem() { this.CalculatorButton('0', '#2196F3', () => this.inputNumber('0')) }
        GridItem() { this.CalculatorButton('.', '#2196F3', () => this.inputNumber('.')) }
        GridItem() { this.CalculatorButton('è¯­éŸ³', '#9c27b0', () => this.simulateVoiceInput()) }
        GridItem() { this.CalculatorButton('ðŸ“Š', '#607d8b', () => this.showHistory()) }
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr 1fr 1fr')
      .width('90%')
      .height(400)
      .columnsGap(8)
      .rowsGap(8)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
    .padding(20)
  }

  @Builder
  CalculatorButton(text: string, color: string, onClick: () => void) {
    Button(text)
      .fontSize(18)
      .fontColor(Color.White)
      .backgroundColor(color)
      .borderRadius(8)
      .width('100%')
      .height('100%')
      .onClick(onClick)
  }

  // è¾“å…¥æ•°å­—
  inputNumber(num: string) {
    if (this.display === '0' && num !== '.') {
      this.display = num
    } else {
      this.display += num
    }
    this.expression += num
  }

  // è¾“å…¥è¿ç®—ç¬¦
  inputOperator(op: string) {
    if (this.expression.length > 0) {
      this.expression += ` ${op} `
      this.display = '0'
    }
  }

  // è®¡ç®—ç»“æžœ
  calculate() {
    try {
      let expr = this.expression.replace(/Ã—/g, '*').replace(/Ã·/g, '/')
      let result = eval(expr)
      this.lastResult = this.expression + ' = ' + result.toString()
      this.display = result.toString()
      this.expression = result.toString()
    } catch (error) {
      this.display = 'é”™è¯¯'
    }
  }

  // æ¸…é™¤
  clear() {
    this.display = '0'
    this.expression = ''
  }

  // é€€æ ¼
  backspace() {
    if (this.display.length > 1) {
      this.display = this.display.slice(0, -1)
    } else {
      this.display = '0'
    }
    if (this.expression.length > 0) {
      this.expression = this.expression.slice(0, -1)
    }
  }

  // åˆ‡æ¢è¯­éŸ³çŠ¶æ€
  toggleVoice() {
    this.isVoiceActive = !this.isVoiceActive
    if (this.isVoiceActive) {
      // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
      setTimeout(() => {
        this.isVoiceActive = false
        this.simulateVoiceInput()
      }, 2000)
    }
  }

  // æ¨¡æ‹Ÿè¯­éŸ³è¾“å…¥
  simulateVoiceInput() {
    const voiceCommands = [
      { text: 'äºŒåŠ ä¸‰', expression: '2 + 3' },
      { text: 'äº”ä¹˜å››', expression: '5 Ã— 4' },
      { text: 'åå‡å…­', expression: '10 - 6' },
      { text: 'å…«é™¤äºŒ', expression: '8 Ã· 2' }
    ]
    
    const random = voiceCommands[Math.floor(Math.random() * voiceCommands.length)]
    
    AlertDialog.show({
      title: 'è¯­éŸ³è¯†åˆ«',
      message: `è¯†åˆ«åˆ°: "${random.text}"\nå°†è¾“å…¥: ${random.expression}`,
      confirm: {
        value: 'ç¡®è®¤',
        action: () => {
          this.expression = random.expression
          this.calculate()
        }
      },
      cancel: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    })
  }

  // æ˜¾ç¤ºåŽ†å²
  showHistory() {
    AlertDialog.show({
      title: 'è®¡ç®—åŽ†å²',
      message: this.lastResult || 'æš‚æ— è®¡ç®—åŽ†å²',
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    })
  }
}